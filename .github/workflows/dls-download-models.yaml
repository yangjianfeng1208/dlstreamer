name: "[DLS] Models update on self-hosted runners"
run-name: "[DLS] Models update on self-hosted runners (by @${{ github.actor }} via ${{ github.event_name }})"
on:
  schedule:
    - cron: '0 5 * * MON' # 5:00 UTC each Monday
  workflow_dispatch:
    inputs:
      models_to_download:
        description: 'Which models to download?'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - public
          - omz
          - specific_model
      specific_os:
        description: 'Which OS to use for downloading? (all/linux/windows)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - linux
          - windows
      specific_model_name:
        description: 'What SPECIFIC model do you want to download?'
        required: false
        type: string
      specific_model_path:
        description: 'Where do you want to download your SPECIFIC model? (public/omz)'
        required: false
        type: string
      runner_labels:
        description: "List of runner(s) labels (example: DLS-TGL-02,DLS-ARL-01)"
        required: false
        type: string

permissions: {}
env:
  MODELS_PATH: "$HOME/models"
  MODELS_PATH_WINDOWS: 'C:\\models'
  MODELS_DIR_MIN_SIZE_MB: 10
  PYTHON_VERSION: '3.12.7'
  WINDOWS_VENV_PATH: 'C:\\dlstreamer-venv'
  DEFAULT_LABELS: "DLS-ARL-01,DLS-ARL-02,DLS-ARL-03,DLS-TGL-01,DLS-TGL-02,DLS-TGL-03,DLS-TGL-04,DLS-TGL-05"

jobs:
  setup-runners:
    if: ${{ !inputs.specific_os || inputs.specific_os == 'all' || inputs.specific_os == 'linux' }}
    name: Set runners to execute update
    runs-on: ubuntu-latest
    outputs:
      runners: ${{ steps.set-labels.outputs.runners }}
    steps:
      - name: Set runners labels
        id: set-labels
        env:
          user_labels: ${{ inputs.runner_labels }}
        run: |
          LABELS=$user_labels
          if [ -z "$LABELS" ]; then
            LABELS="${{ env.DEFAULT_LABELS }}" # Use default configuration if user didn't set any input labels
          fi
          LABELS_ARRAY=$(echo "$LABELS" | jq -Rc 'split(",")')
          echo "Runners lables array: $LABELS_ARRAY"
          echo "runners=$LABELS_ARRAY" >> $GITHUB_OUTPUT
  update_linux_hosts:
    if: ${{ !inputs.specific_os || inputs.specific_os == 'all' || inputs.specific_os == 'linux' }}
    name: Update on Linux runners
    needs: setup-runners
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        runner: ${{ fromJson(needs.setup-runners.outputs.runners) }}
    runs-on:
      - ${{ matrix.runner }}
    steps:
      - name: Get script
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #5.0.0
        with:
          persist-credentials: false
          path: dlstreamer-repo

      - name: Download only specific model
        env:
          model_path: ${{ inputs.specific_model_path }}
          model_name: ${{ inputs.specific_model_name }}
        if: ${{ inputs.models_to_download == 'specific_model' }}
        run: |
          MODEL_PATH=$model_path
          MODEL_NAME=$model_name
          export MODELS_PATH=${{ env.MODELS_PATH }}
          echo "MODEL_PATH=$MODEL_PATH"
          echo "MODEL_NAME=$MODEL_NAME"
          echo "Downloading specific model ${{ env.MODELS_PATH }}/$MODEL_PATH/$MODEL_NAME"  >> $GITHUB_STEP_SUMMARY
          if [ -d "${{ env.MODELS_PATH }}/$MODEL_PATH/$MODEL_NAME" ]; then
            echo "Removing $MODEL_NAME directory"
            rm -rf "${{ env.MODELS_PATH }}/$MODEL_PATH/$MODEL_NAME"
            if [[ "$MODEL_PATH" == "public" ]]; then
              ./dlstreamer-repo/samples/download_public_models.sh "$MODEL_NAME" coco128
            elif [[ "$MODEL_PATH" == "omz" ]]; then
              mkdir -p .virtualenvs/dlstreamer
              python3 -m venv .virtualenvs/dlstreamer
              source .virtualenvs/dlstreamer/bin/activate
              pip3 install --no-cache-dir --upgrade tensorflow==2.19.1 openvino-dev[onnx]==2024.6.0 torch==2.8.0
              export MODELS_PATH=${{ env.MODELS_PATH }}
              ./dlstreamer-repo/samples/download_omz_models.sh $MODEL_NAME
              deactivate
            fi
          fi
      - name: Prepare directories - public models
        if: ${{ inputs.models_to_download == 'public' || inputs.models_to_download == 'all' || github.event_name == 'schedule' }}
        run: |
          # Prepare directories with backup of existing ones
          # 1) mv public_old public_old_old
          # 2) mv public public_old
          if [ -d "${{ env.MODELS_PATH }}/public_old" ]; then
            echo "Changing directories names: public_old -> public_old_old"
            [ -d "${{ env.MODELS_PATH }}/public_old_old" ] && rm -r "${{ env.MODELS_PATH }}/public_old_old"
            mv "${{ env.MODELS_PATH }}/public_old" "${{ env.MODELS_PATH }}/public_old_old"
          fi
          if [ -d "${{ env.MODELS_PATH }}/public" ]; then
            echo "Changing directories names: public -> public_old"
            [ -d "${{ env.MODELS_PATH }}/public_old" ] && rm -r "${{ env.MODELS_PATH }}/public_old"
            mv "${{ env.MODELS_PATH }}/public" "${{ env.MODELS_PATH }}/public_old"
          fi
      - name: Prepare directories - OMZ models
        if: ${{ inputs.models_to_download == 'omz' || inputs.models_to_download == 'all' || github.event_name == 'schedule'  }}
        run: |
          # Prepare directories with backup of existing ones
          # 1) mv intel intel_old
          # 2) mv intel_old intel_old_old
          if [ -d "${{ env.MODELS_PATH }}/intel_old" ]; then
            echo "Changing directories names: intel_old -> intel_old_old"
            [ -d "${{ env.MODELS_PATH }}/intel_old_old" ] && rm -r "${{ env.MODELS_PATH }}/intel_old_old"
            mv "${{ env.MODELS_PATH }}/intel_old" "${{ env.MODELS_PATH }}/intel_old_old"
          fi
          if [ -d "${{ env.MODELS_PATH }}/intel" ]; then
            echo "Changing directories names: intel -> intel_old"
            [ -d "${{ env.MODELS_PATH }}/intel_old" ] && rm -r "${{ env.MODELS_PATH }}/intel_old"
            mv "${{ env.MODELS_PATH }}/intel" "${{ env.MODELS_PATH }}/intel_old"
          fi
      - name: Download public models
        id: download-public
        if: ${{ inputs.models_to_download == 'public' || inputs.models_to_download == 'all' || github.event_name == 'schedule'  }}
        run: |
          export MODELS_PATH=${{ env.MODELS_PATH }}
          echo "Downloading public models"
          ./dlstreamer-repo/samples/download_public_models.sh all coco128
      - name: Download OMZ models (setup venv, dependencies and download)
        id: download-omz
        if: ${{ inputs.models_to_download == 'omz' || inputs.models_to_download == 'all' || github.event_name == 'schedule'  }}
        run: |
          mkdir -p .virtualenvs/dlstreamer
          python3 -m venv .virtualenvs/dlstreamer
          source .virtualenvs/dlstreamer/bin/activate
          pip3 install --no-cache-dir --upgrade tensorflow==2.19.1 openvino-dev[onnx]==2024.6.0 torch==2.8.0
          export MODELS_PATH=${{ env.MODELS_PATH }}
          ./dlstreamer-repo/samples/download_omz_models.sh
          deactivate
      - name: Verify public models downloading
        id: verify-public
        if: >
            steps.download-public.outcome == 'success' &&
            (inputs.models_to_download == 'public' || inputs.models_to_download == 'all' || github.event_name == 'schedule')
        run: |
          if [ -z "$( ls -A ${{ env.MODELS_PATH }}/public )" ]; then
            echo "Public models not downloaded correctly - directory not created ❌"
            echo "Public models not downloaded - directory not created ❌" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "Public models directory created"
            echo "Public models directory created" >> $GITHUB_STEP_SUMMARY
            DIR_SIZE_MB=$(du -sm "${{ env.MODELS_PATH }}/public" | cut -f1)
            echo "Public models directory size: ${DIR_SIZE_MB} MB"
            echo "Public models directory size: ${DIR_SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY
            if [ "$DIR_SIZE_MB" -ge "${{ env.MODELS_DIR_MIN_SIZE_MB }}" ]; then
              echo "Public models downloaded ✅"
              echo "Public models downloaded ✅" >> $GITHUB_STEP_SUMMARY
            else
              Public models not downloaded correctly - directory too small ❌"
              Public models not downloaded correctly - directory too small ❌" >> $GITHUB_STEP_SUMMARY
            fi
          fi
      - name: Verify OMZ models downloading
        id: verify-omz
        if: >
            steps.download-omz.outcome == 'success' &&
            (inputs.models_to_download == 'omz' || inputs.models_to_download == 'all' || github.event_name == 'schedule')
        run: |
          if [ -z "$( ls -A ${{ env.MODELS_PATH }}/intel )" ]; then
            echo "Open Model Zoo models not downloaded correctly - directory not created ❌"
            echo "Open Model Zoo models not downloaded - directory not created ❌" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "Open Model Zoo models directory created"
            echo "Open Model Zoo models directory created" >> $GITHUB_STEP_SUMMARY
            DIR_SIZE_MB=$(du -sm "${{ env.MODELS_PATH }}/intel" | cut -f1)
            echo "Open Model Zoo models directory size: ${DIR_SIZE_MB} MB"
            echo "Open Model Zoo models directory size: ${DIR_SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY
            if [ "$DIR_SIZE_MB" -ge "${{ env.MODELS_DIR_MIN_SIZE_MB }}" ]; then
              echo "Open Model Zoo models downloaded ✅"
              echo "Open Model Zoo models downloaded ✅" >> $GITHUB_STEP_SUMMARY
            else
              Open Model Zoo models not downloaded correctly - directory too small ❌"
              Open Model Zoo models not downloaded correctly - directory too small ❌" >> $GITHUB_STEP_SUMMARY
            fi
          fi
      - name: Manage public models directories after success
        if: ${{ steps.verify-public.outcome == 'success' && steps.download-public.outcome == 'success' }}
        run: |
          [ -d "${{ env.MODELS_PATH }}/public_old_old" ] &&  rm -rf "${{ env.MODELS_PATH }}/public_old_old"
          echo "New public models set up ✅" >> $GITHUB_STEP_SUMMARY
      - name: Manage OMZ models directories after success
        if: ${{ steps.verify-omz.outcome == 'success' && steps.download-omz.outcome == 'success' }}
        run: |
          [ -d "${{ env.MODELS_PATH }}/intel_old_old" ] &&  rm -rf "${{ env.MODELS_PATH }}/intel_old_old"
          echo "New Open Model Zoo models set up ✅" >> $GITHUB_STEP_SUMMARY
      - name: Restore public models directories after fail
        if: ${{ always() && steps.download-public.outcome != 'skipped' && !(steps.verify-public.outcome == 'success' && steps.download-public.outcome == 'success') }}
        run: |
          [ -d "${{ env.MODELS_PATH }}/public" ] && rm -rf "${{ env.MODELS_PATH }}/public"
          [ -d "${{ env.MODELS_PATH }}/public_old" ] && mv "${{ env.MODELS_PATH }}/public_old" "${{ env.MODELS_PATH }}/public"
          [ -d "${{ env.MODELS_PATH }}/public_old_old" ] && mv "${{ env.MODELS_PATH }}/public_old_old" "${{ env.MODELS_PATH }}/public_old"
          echo "Old public models restored" >> $GITHUB_STEP_SUMMARY
      - name: Restore OMZ models directories after fail
        if: ${{ always() && steps.download-omz.outcome != 'skipped' && !(steps.verify-omz.outcome == 'success' && steps.download-omz.outcome == 'success') }}
        run: |
          [ -d "${{ env.MODELS_PATH }}/intel" ] && rm -rf "${{ env.MODELS_PATH }}/intel"
          [ -d "${{ env.MODELS_PATH }}/intel_old" ] && mv "${{ env.MODELS_PATH }}/intel_old" "${{ env.MODELS_PATH }}/intel"
          [ -d "${{ env.MODELS_PATH }}/intel_old_old" ] && mv "${{ env.MODELS_PATH }}/intel_old_old" "${{ env.MODELS_PATH }}/intel_old"
          echo "Old Open Model Zoo models restored" >> $GITHUB_STEP_SUMMARY
      - name: Clean up
        if: always()
        run: |
          rm -rf dlstreamer-repo .virtualenvs
          rm -rf $HOME/.virtualenvs

  update_windows_hosts:
    if: ${{ !inputs.specific_os || inputs.specific_os == 'all' || inputs.specific_os == 'windows' }}
    name: Update on Windows runners
    permissions:
      contents: read
    runs-on:
      - self-hosted
      - dlstreamer
      - ARL
      - windows
    steps:
      - name: Get script
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # 5.0.0
        with:
          persist-credentials: false
          path: dlstreamer-repo
          clean: false

      - name: Install Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # 5.0.0
        id: cp312
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          clean: false

      - name: Capture Python path
        env:
          RAW_PYTHON_PATH: ${{ steps.cp312.outputs.python-path }}
        shell: powershell
        run: |
          $actualPath = "$env:RAW_PYTHON_PATH"
          Write-Host "Detected Python Path: $actualPath"
          echo "PYTHON_EXE_PATH=$actualPath" >> $env:GITHUB_ENV

      - name: Download specific public model on Windows
        if: ${{ inputs.models_to_download == 'specific_model' && inputs.specific_model_path == 'public' }}
        shell: C:\Progra~1\Git\bin\bash.exe -eo pipefail {0}
        env:
          SPECIFIC_MODEL_NAME: ${{ inputs.specific_model_name }}
        run: |
          set -eo pipefail
          if [[ -z "${SPECIFIC_MODEL_NAME}" ]]; then
            echo "specific_model_name input is required when running on Windows" >&2
            exit 1
          fi
          export MODELS_PATH=$(cygpath -m "${{ env.MODELS_PATH_WINDOWS }}")
          mkdir -p "${MODELS_PATH}/public"
          target_dir="${MODELS_PATH}/public/${SPECIFIC_MODEL_NAME}"
          rm -rf "${target_dir}"
          workspace_posix=$(cygpath -u "${GITHUB_WORKSPACE}")
          cd "${workspace_posix}/dlstreamer-repo/samples"
          ./download_public_models.sh "${SPECIFIC_MODEL_NAME}" coco128
          echo "Downloaded ${SPECIFIC_MODEL_NAME} to ${target_dir}" >> "${GITHUB_STEP_SUMMARY}"

      - name: Prepare directories - public models (Windows)
        if: ${{ inputs.models_to_download == 'public' || inputs.models_to_download == 'all' || github.event_name == 'schedule' }}
        shell: powershell
        run: |
          $modelsPath = "${{ env.MODELS_PATH_WINDOWS }}"
          if (-not (Test-Path $modelsPath)) {
              New-Item -ItemType Directory -Path $modelsPath | Out-Null
          }
          $public = Join-Path $modelsPath "public"
          $publicOld = Join-Path $modelsPath "public_old"
          $publicOldOld = Join-Path $modelsPath "public_old_old"
          if (Test-Path $publicOld) {
              if (Test-Path $publicOldOld) {
                  Remove-Item -Recurse -Force $publicOldOld
              }
              Rename-Item -Path $publicOld -NewName "public_old_old"
          }
          if (Test-Path $public) {
              if (Test-Path $publicOld) {
                  Remove-Item -Recurse -Force $publicOld
              }
              Rename-Item -Path $public -NewName "public_old"
          }

      - name: Download public models on Windows
        id: download-public-windows
        if: ${{ inputs.models_to_download == 'public' || inputs.models_to_download == 'all' || github.event_name == 'schedule' }}
        shell: C:\Progra~1\Git\bin\bash.exe -eo pipefail {0}
        run: |
          set -eo pipefail
          export MODELS_PATH=$(cygpath -m "${{ env.MODELS_PATH_WINDOWS }}")
          workspace_posix=$(cygpath -u "${GITHUB_WORKSPACE}")
          cd "${workspace_posix}/dlstreamer-repo/samples"
          ./download_public_models.sh all coco128

      - name: Verify public models downloading on Windows
        id: verify-public-windows
        if: >
          steps.download-public-windows.outcome == 'success' &&
          (inputs.models_to_download == 'public' || inputs.models_to_download == 'all' || github.event_name == 'schedule')
        shell: powershell
        run: |
          $publicDir = Join-Path "${{ env.MODELS_PATH_WINDOWS }}" "public"
            if (-not (Test-Path $publicDir)) {
              throw "Public models not downloaded correctly - directory not created"
            }
            $files = Get-ChildItem -Path $publicDir -Recurse -File -ErrorAction SilentlyContinue
            if (-not $files) {
              throw "Public models not downloaded correctly - directory is empty"
            }
          $sizeBytes = ($files | Measure-Object -Property Length -Sum).Sum
          $sizeMB = if ($sizeBytes) { [math]::Round($sizeBytes / 1MB, 2) } else { 0 }
          "Windows public models directory size: $sizeMB MB" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
            if ($sizeMB -lt ${{ env.MODELS_DIR_MIN_SIZE_MB }}) {
              throw "Public models not downloaded correctly on Windows - directory too small"
            }
            "Public models downloaded on Windows" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

      - name: Manage public models directories after success (Windows)
        if: ${{ steps.verify-public-windows.outcome == 'success' && steps.download-public-windows.outcome == 'success' }}
        shell: powershell
        run: |
          $publicOldOld = Join-Path "${{ env.MODELS_PATH_WINDOWS }}" "public_old_old"
          if (Test-Path $publicOldOld) {
              Remove-Item -Recurse -Force $publicOldOld
          }
          "New Windows public models set up" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

      - name: Restore public models directories after fail (Windows)
        if: ${{ always() && steps.download-public-windows.outcome != 'skipped' && !(steps.verify-public-windows.outcome == 'success' && steps.download-public-windows.outcome == 'success') }}
        shell: powershell
        run: |
          $modelsPath = $env:MODELS_PATH_WINDOWS
          $public = Join-Path $modelsPath "public"
          $publicOld = Join-Path $modelsPath "public_old"
          $publicOldOld = Join-Path $modelsPath "public_old_old"
          if (Test-Path $public) {
              Remove-Item -Recurse -Force $public
          }
          if (Test-Path $publicOld) {
              Rename-Item -Path $publicOld -NewName "public"
          }
          if (Test-Path $publicOldOld) {
              Rename-Item -Path $publicOldOld -NewName "public_old"
          }
          "Old Windows public models restored" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

      - name: Download OMZ models on Windows (setup venv, dependencies and download)
        id: download-omz-windows
        if: ${{ inputs.models_to_download == 'omz' || inputs.models_to_download == 'all' || github.event_name == 'schedule' }}
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          $modelsPath = $env:MODELS_PATH_WINDOWS
          if (-not (Test-Path $modelsPath)) {
              New-Item -ItemType Directory -Path $modelsPath | Out-Null
          }
          $env:MODELS_PATH = $modelsPath

          $venvPath = $env:WINDOWS_VENV_PATH
          $pythonExe = $env:PYTHON_EXE_PATH
          if (-not (Test-Path $pythonExe)) {
              throw "Python executable not found at $pythonExe"
          }

          & $pythonExe -m venv $venvPath

          $venvScripts = Join-Path $venvPath 'Scripts'
          $venvPython = Join-Path $venvScripts 'python.exe'
          if (-not (Test-Path $venvPython)) {
              throw "Virtual environment python.exe not found at $venvPython"
          }

          & $venvPython -m pip install --no-cache-dir --upgrade tensorflow==2.19.1 openvino-dev[onnx]==2024.6.0 torch==2.8.0

          $samplesWindowsDir = Join-Path "${{ github.workspace }}" 'dlstreamer-repo\samples\windows'
          if (-not (Test-Path $samplesWindowsDir)) {
              throw "Samples directory not found: $samplesWindowsDir"
          }
          $downloadBatch = Join-Path $samplesWindowsDir 'download_omz_models.bat'
          if (-not (Test-Path $downloadBatch)) {
              throw "Batch file not found: $downloadBatch"
          }

          $activateBat = Join-Path $venvScripts 'activate.bat'
          if (-not (Test-Path $activateBat)) {
              throw "Activation script not found: $activateBat"
          }

          $cmd = 'call "{0}" && cd /d "{1}" && call "{2}"' -f $activateBat, $samplesWindowsDir, $downloadBatch
          cmd.exe /c $cmd
          if ($LASTEXITCODE -ne 0) {
              throw "download_omz_models.bat failed with exit code $LASTEXITCODE"
          }

      - name: Verify OMZ models downloading on Windows
        id: verify-omz-windows
        if: >
          steps.download-omz-windows.outcome == 'success' &&
          (inputs.models_to_download == 'omz' || inputs.models_to_download == 'all' || github.event_name == 'schedule')
        shell: powershell
        run: |
          $intelDir = Join-Path "${{ env.MODELS_PATH_WINDOWS }}" "intel"
          if (-not (Test-Path $intelDir)) {
              throw "OMZ models not downloaded correctly - directory not created"
          }
          $files = Get-ChildItem -Path $intelDir -Recurse -File -ErrorAction SilentlyContinue
          if (-not $files) {
              throw "OMZ models not downloaded correctly - directory is empty"
          }
          $sizeBytes = ($files | Measure-Object -Property Length -Sum).Sum
          $sizeMB = if ($sizeBytes) { [math]::Round($sizeBytes / 1MB, 2) } else { 0 }
          "Windows OMZ models directory size: $sizeMB MB" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          if ($sizeMB -lt ${{ env.MODELS_DIR_MIN_SIZE_MB }}) {
              throw "OMZ models not downloaded correctly on Windows - directory too small"
          }
          "OMZ models downloaded on Windows" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

      - name: Manage OMZ models directories after success (Windows)
        if: ${{ steps.verify-omz-windows.outcome == 'success' && steps.download-omz-windows.outcome == 'success' }}
        shell: powershell
        run: |
          $intelOldOld = Join-Path "${{ env.MODELS_PATH_WINDOWS }}" "intel_old_old"
          if (Test-Path $intelOldOld) {
              Remove-Item -Recurse -Force $intelOldOld
          }
          "New Windows OMZ models set up" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

      - name: Restore OMZ models directories after fail (Windows)
        if: ${{ always() && steps.download-omz-windows.outcome != 'skipped' && !(steps.verify-omz-windows.outcome == 'success' && steps.download-omz-windows.outcome == 'success') }}
        shell: powershell
        run: |
          $modelsPath = "${{ env.MODELS_PATH_WINDOWS }}"
          $intel = Join-Path $modelsPath "intel"
          $intelOld = Join-Path $modelsPath "intel_old"
          $intelOldOld = Join-Path $modelsPath "intel_old_old"
          if (Test-Path $intel) {
              Remove-Item -Recurse -Force $intel
          }
          if (Test-Path $intelOld) {
              Rename-Item -Path $intelOld -NewName "intel"
          }
          if (Test-Path $intelOldOld) {
              Rename-Item -Path $intelOldOld -NewName "intel_old"
          }
          "Old Windows OMZ models restored" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

      - name: Clean up Windows workspace
        if: always()
        shell: powershell
        run: |
          Remove-Item -Recurse -Force "${{ github.workspace }}\dlstreamer-repo" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "$HOME\.virtualenvs" -ErrorAction SilentlyContinue
